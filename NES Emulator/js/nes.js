function Nes(){this.stateVersion=1,this.ram=new Uint8Array(2048),this.cpu=new Cpu(this),this.ppu=new Ppu(this),this.apu=new Apu(this),this.mapper,this.currentControl1State=0,this.currentControl2State=0,this.onread=void 0,this.onwrite=void 0,this.onexecute=void 0,this.reset=function(a){if(a)for(let a=0;a<this.ram.length;a++)this.ram[a]=0;this.cpu.reset(),this.ppu.reset(),this.apu.reset(),this.mapper&&this.mapper.reset(a),this.cycles=0,this.inDma=!1,this.dmaTimer=0,this.dmaBase=0,this.dmaValue=0,this.latchedControl1State=0,this.latchedControl2State=0,this.controllerLatched=!1,this.mapperIrqWanted=!1,this.frameIrqWanted=!1,this.dmcIrqWanted=!1},this.reset(!0),this.saveVars=["ram","cycles","inDma","dmaTimer","dmaBase","dmaValue","latchedControl1State","latchedControl2State","controllerLatched","mapperIrqWanted","frameIrqWanted","dmcIrqWanted"],this.loadRom=function(a){if(16>a.length)return log("Invalid rom loaded"),!1;if(78!==a[0]||69!==a[1]||83!==a[2]||26!==a[3])return log("Invalid rom loaded"),!1;let b=this.parseHeader(a);if(a.length<b.chrBase+8192*b.chrBanks)return log("Rom file is missing data"),!1;if(void 0===mappers[b.mapper])return log("Unsupported mapper: "+b.mapper),!1;try{this.mapper=new mappers[b.mapper](this,a,b)}catch(a){return log("Rom load error: "+a),!1}return log("Loaded "+this.mapper.name+" rom: "+this.mapper.h.banks+" PRG bank(s), "+this.mapper.h.chrBanks+" CHR bank(s)"),!0},this.parseHeader=function(a){let b={banks:a[4],chrBanks:a[5],mapper:a[6]>>4|240&a[7],verticalMirroring:0<(1&a[6]),battery:0<(2&a[6]),trainer:0<(4&a[6]),fourScreen:0<(8&a[6])};return b.base=16+(b.trainer?512:0),b.chrBase=b.base+16384*b.banks,b.prgAnd=16384*b.banks-1,b.chrAnd=0===b.chrBanks?8191:8192*b.chrBanks-1,b.saveVars=["banks","chrBanks","mapper","verticalMirroring","battery","trainer","fourScreen"],b},this.getPixels=function(a){this.ppu.setFrame(a)},this.getSamples=function(a,b){let c=this.apu.getOutput(),d=0,e=0;for(let f=0;f<b;f++){e+=29780/b;let g=0,h=65535&e;for(let a=d;a<d+h;a++)g+=c[1][a];a[f]=g/h,d+=h,e-=h}},this.cycle=function(){0===this.cycles&&(this.cycles=3,this.controllerLatched&&(this.latchedControl1State=this.currentControl1State,this.latchedControl2State=this.currentControl2State),this.cpu.irqWanted=!!(this.mapperIrqWanted||this.frameIrqWanted||this.dmcIrqWanted),this.inDma?(0<this.dmaTimer&&(0==(1&this.dmaTimer)?this.ppu.write(4,this.dmaValue):this.dmaValue=this.read(this.dmaBase+(255&this.dmaTimer/2))),this.dmaTimer++,513===this.dmaTimer&&(this.dmaTimer=0,this.inDma=!1)):(this.onexecute&&0===this.cpu.cyclesLeft&&this.onexecute(this.cpu.br[0],this.peak(this.cpu.br[0])),this.cpu.cycle()),this.apu.cycle()),this.ppu.cycle(),this.cycles--},this.runFrame=function(){do this.cycle();while(240!==this.ppu.line||0!==this.ppu.dot)},this.peak=function(a){if(a&=65535,8192>a)return this.ram[2047&a];if(16384>a)return this.ppu.peak(7&a);if(16416>a){if(16404===a)return 0;if(16406===a){let a=1&this.latchedControl1State;return 64|a}if(16407===a){let a=1&this.latchedControl2State;return 64|a}return this.apu.peak(a)}return this.mapper.peak(a)},this.read=function(a){if(a&=65535,this.onread&&this.onread(a,this.peak(a)),8192>a)return this.ram[2047&a];if(16384>a)return this.ppu.read(7&a);if(16416>a){if(16404===a)return 0;if(16406===a){let a=1&this.latchedControl1State;return this.latchedControl1State>>=1,this.latchedControl1State|=128,64|a}if(16407===a){let a=1&this.latchedControl2State;return this.latchedControl2State>>=1,this.latchedControl2State|=128,64|a}return this.apu.read(a)}return this.mapper.read(a)},this.write=function(a,b){return a&=65535,this.onwrite&&this.onwrite(a,b),8192>a?void(this.ram[2047&a]=b):16384>a?void this.ppu.write(7&a,b):16416>a?16404===a?(this.inDma=!0,void(this.dmaBase=b<<8)):16406===a?void(this.controllerLatched=!!(0<(1&b))):void this.apu.write(a,b):void this.mapper.write(a,b)},this.getByteRep=function(a){return("0"+a.toString(16)).slice(-2)},this.getWordRep=function(a){return("000"+a.toString(16)).slice(-4)},this.setButtonPressed=function(a,b){1===a?this.currentControl1State|=1<<b:2==a&&(this.currentControl2State|=1<<b)},this.setButtonReleased=function(a,b){1===a?this.currentControl1State&=255&~(1<<b):2==a&&(this.currentControl2State&=255&~(1<<b))},this.INPUT={A:0,B:1,SELECT:2,START:3,UP:4,DOWN:5,LEFT:6,RIGHT:7},this.getBattery=function(){return this.mapper.h.battery?{data:this.mapper.getBattery()}:void 0},this.setBattery=function(a){return!this.mapper.h.battery||this.mapper.setBattery(a.data)},this.getState=function(){let a=this.getObjState(this.cpu),b=this.getObjState(this.ppu),c=this.getObjState(this.apu),d=this.getObjState(this.mapper),e=this.getObjState(this.mapper.h),f=this.getObjState(this);return f.cpu=a,f.ppu=b,f.apu=c,f.mapper=d,f.header=e,f.mapperVersion=this.mapper.version,f.version=this.stateVersion,f},this.setState=function(a){return a.version===this.stateVersion&&a.mapperVersion===this.mapper.version&&!!this.checkObjState(this.mapper.h,a.header)&&(this.setObjState(this.cpu,a.cpu),this.setObjState(this.ppu,a.ppu),this.setObjState(this.apu,a.apu),this.setObjState(this.mapper,a.mapper),this.setObjState(this,a),!0)},this.getObjState=function(a){let b={};for(let c=0;c<a.saveVars.length;c++){let d=a.saveVars[c],e=a[d];b[d]=e instanceof Uint8Array||e instanceof Uint16Array?Array.prototype.slice.call(e):e}return b},this.setObjState=function(a,b){for(let c=0;c<a.saveVars.length;c++){let d=a.saveVars[c],e=a[d];a[d]=e instanceof Uint8Array?new Uint8Array(b[d]):e instanceof Uint16Array?new Uint16Array(b[d]):b[d]}},this.checkObjState=function(a,b){for(let c,d=0;d<a.saveVars.length;d++)if(c=a.saveVars[d],a[c]!==b[c])return!1;return!0}}