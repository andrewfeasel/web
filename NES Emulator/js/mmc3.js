mappers[4]=function(a,b,c){this.name="MMC3",this.version=1,this.nes=a,this.rom=b,this.h=c,this.chrRam=new Uint8Array(8192),this.prgRam=new Uint8Array(8192),this.ppuRam=new Uint8Array(2048),this.bankRegs=new Uint8Array(8),this.reset=function(a){if(a){for(let a=0;a<this.chrRam.length;a++)this.chrRam[a]=0;if(!this.h.battery)for(let a=0;a<this.prgRam.length;a++)this.prgRam[a]=0;for(let a=0;a<this.ppuRam.length;a++)this.ppuRam[a]=0}for(let b=0;b<this.bankRegs.length;b++)this.bankRegs[b]=0;this.mirroring=0,this.prgMode=1,this.chrMode=1,this.regSelect=0,this.reloadIrq=!1,this.irqLatch=0,this.irqEnabled=!1,this.irqCounter=0,this.lastRead=0},this.reset(!0),this.saveVars=["name","chrRam","prgRam","ppuRam","bankRegs","mirroring","prgMode","chrMode","regSelect","reloadIrq","irqLatch","irqEnabled","irqCounter","lastRead"],this.getBattery=function(){return Array.prototype.slice.call(this.prgRam)},this.setBattery=function(a){return!(8192!==a.length)&&(this.prgRam=new Uint8Array(a),!0)},this.getRomAdr=function(a){let b=0;return b=1===this.prgMode?40960>a?8192*(2*this.h.banks-2)+(8191&a):49152>a?8192*this.bankRegs[7]+(8191&a):57344>a?8192*this.bankRegs[6]+(8191&a):8192*(2*this.h.banks-1)+(8191&a):40960>a?8192*this.bankRegs[6]+(8191&a):49152>a?8192*this.bankRegs[7]+(8191&a):57344>a?8192*(2*this.h.banks-2)+(8191&a):8192*(2*this.h.banks-1)+(8191&a),b&this.h.prgAnd},this.getMirroringAdr=function(a){return 0===this.mirroring?2047&a:1023&a|(2048&a)>>1},this.getChrAdr=function(a){1===this.chrMode&&(a^=4096);let b=0;return b=2048>a?2048*(this.bankRegs[0]>>1)+(2047&a):4096>a?2048*(this.bankRegs[1]>>1)+(2047&a):5120>a?1024*this.bankRegs[2]+(1023&a):6144>a?1024*this.bankRegs[3]+(1023&a):7168>a?1024*this.bankRegs[4]+(1023&a):1024*this.bankRegs[5]+(1023&a),b&this.h.chrAnd},this.clockIrq=function(){0===this.irqCounter||this.reloadIrq?(this.irqCounter=this.irqLatch,this.reloadIrq=!1):(this.irqCounter--,this.irqCounter&=255),0===this.irqCounter&&this.irqEnabled&&(this.nes.mapperIrqWanted=!0)},this.peak=function(a){return this.read(a)},this.read=function(a){return 24576>a?0:32768>a?this.prgRam[8191&a]:this.rom[this.h.base+this.getRomAdr(a)]},this.write=function(a,b){if(!(24576>a)){if(32768>a)return void(this.prgRam[8191&a]=b);switch(24577&a){case 0:{this.regSelect=7&b,this.prgMode=(64&b)>>6,this.chrMode=(128&b)>>7;break}case 1:{this.bankRegs[this.regSelect]=b;break}case 8192:{this.mirroring=1&b;break}case 8193:break;case 16384:{this.irqLatch=b;break}case 16385:{this.reloadIrq=!0;break}case 24576:{this.irqEnabled=!1,this.nes.mapperIrqWanted=!1;break}case 24577:{this.irqEnabled=!0;break}}}},this.ppuPeak=function(a){return 8192>a?0===this.h.chrBanks?this.chrRam[this.getChrAdr(a)]:this.rom[this.h.chrBase+this.getChrAdr(a)]:this.ppuRam[this.getMirroringAdr(a)]},this.ppuRead=function(a){return 8192>a?(0==(4096&this.lastRead)&&0<(4096&a)&&this.clockIrq(),this.lastRead=a,0===this.h.chrBanks?this.chrRam[this.getChrAdr(a)]:this.rom[this.h.chrBase+this.getChrAdr(a)]):this.ppuRam[this.getMirroringAdr(a)]},this.ppuWrite=function(a,b){return 8192>a?0===this.h.chrBanks?void(this.chrRam[this.getChrAdr(a)]=b):void 0:this.ppuRam[this.getMirroringAdr(a)]=b}};