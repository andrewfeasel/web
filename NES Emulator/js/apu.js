function Apu(a){this.nes=a,this.dutyCycles=[[0,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,1,1,1,1,0,0,0],[1,0,0,1,1,1,1,1]],this.lengthLoadValues=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],this.triangleSteps=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],this.noiseLoadValues=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],this.dmcLoadValues=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],this.output=new Float64Array(29781),this.reset=function(){for(let a=0;a<this.output.length;a++)this.output[a]=0;this.outputOffset=0,this.frameCounter=0,this.interruptInhibit=!1,this.step5Mode=!1,this.enableNoise=!1,this.enableTriangle=!1,this.enablePulse2=!1,this.enablePulse1=!1,this.p1Timer=0,this.p1TimerValue=0,this.p1Duty=0,this.p1DutyIndex=0,this.p1Output=0,this.p1CounterHalt=!1,this.p1Counter=0,this.p1Volume=0,this.p1ConstantVolume=!1,this.p1Decay=0,this.p1EnvelopeCounter=0,this.p1EnvelopeStart=!1,this.p1SweepEnabled=!1,this.p1SweepPeriod=0,this.p1SweepNegate=!1,this.p1SweepShift=0,this.p1SweepTimer=0,this.p1SweepTarget=0,this.p1SweepMuting=!0,this.p1SweepReload=!1,this.p2Timer=0,this.p2TimerValue=0,this.p2Duty=0,this.p2DutyIndex=0,this.p2Output=0,this.p2CounterHalt=!1,this.p2Counter=0,this.p2Volume=0,this.p2ConstantVolume=!1,this.p2Decay=0,this.p2EnvelopeCounter=0,this.p2EnvelopeStart=!1,this.p2SweepEnabled=!1,this.p2SweepPeriod=0,this.p2SweepNegate=!1,this.p2SweepShift=0,this.p2SweepTimer=0,this.p2SweepTarget=0,this.p2SweepMuting=!0,this.p2SweepReload=!1,this.triTimer=0,this.triTimerValue=0,this.triStepIndex=0,this.triOutput=0,this.triCounterHalt=!1,this.triCounter=0,this.triLinearCounter=0,this.triReloadLinear=!1,this.triLinearReload=0,this.noiseTimer=0,this.noiseTimerValue=0,this.noiseShift=1,this.noiseTonal=!1,this.noiseOutput=0,this.noiseCounterHalt=!1,this.noiseCounter=0,this.noiseVolume=0,this.noiseConstantVolume=!1,this.noiseDecay=0,this.noiseEnvelopeCounter=0,this.noiseEnvelopeStart=!1,this.dmcInterrupt=!1,this.dmcLoop=!1,this.dmcTimer=0,this.dmcTimerValue=0,this.dmcOutput=0,this.dmcSampleAddress=49152,this.dmcAddress=49152,this.dmcSample=0,this.dmcSampleLength=0,this.dmcSampleEmpty=!0,this.dmcBytesLeft=0,this.dmcShifter=0,this.dmcBitsLeft=8,this.dmcSilent=!0},this.reset(),this.saveVars=["frameCounter","interruptInhibit","step5Mode","enableNoise","enableTriangle","enablePulse2","enablePulse1","p1Timer","p1TimerValue","p1Duty","p1DutyIndex","p1Output","p1CounterHalt","p1Counter","p1Volume","p1ConstantVolume","p1Decay","p1EnvelopeCounter","p1EnvelopeStart","p1SweepEnabled","p1SweepPeriod","p1SweepNegate","p1SweepShift","p1SweepTimer","p1SweepTarget","p1SweepMuting","p1SweepReload","p2Timer","p2TimerValue","p2Duty","p2DutyIndex","p2Output","p2CounterHalt","p2Counter","p2Volume","p2ConstantVolume","p2Decay","p2EnvelopeCounter","p2EnvelopeStart","p2SweepEnabled","p2SweepPeriod","p2SweepNegate","p2SweepShift","p2SweepTimer","p2SweepTarget","p2SweepMuting","p2SweepReload","triTimer","triTimerValue","triStepIndex","triOutput","triCounterHalt","triCounter","triLinearCounter","triReloadLinear","triLinearReload","noiseTimer","noiseTimerValue","noiseShift","noiseTonal","noiseOutput","noiseCounterHalt","noiseCounter","noiseVolume","noiseConstantVolume","noiseDecay","noiseEnvelopeCounter","noiseEnvelopeStart","dmcInterrupt","dmcLoop","dmcTimer","dmcTimerValue","dmcOutput","dmcSampleAddress","dmcAddress","dmcSample","dmcSampleLength","dmcSampleEmpty","dmcBytesLeft","dmcShifter","dmcBitsLeft","dmcSilent"],this.cycle=function(){(29830!==this.frameCounter||this.step5Mode)&&37282!==this.frameCounter||(this.frameCounter=0),this.frameCounter++,this.handleFrameCounter(),this.cycleTriangle(),this.cyclePulse1(),this.cyclePulse2(),this.cycleNoise(),this.cycleDmc(),this.output[this.outputOffset++]=this.mix(),29781===this.outputOffset&&(this.outputOffset=29780)},this.cyclePulse1=function(){0===this.p1TimerValue?(this.p1TimerValue=2*this.p1Timer+1,this.p1DutyIndex++,this.p1DutyIndex&=7):this.p1TimerValue--;let a=this.dutyCycles[this.p1Duty][this.p1DutyIndex];this.p1Output=0===a||this.p1SweepMuting||0===this.p1Counter?0:this.p1ConstantVolume?this.p1Volume:this.p1Decay},this.cyclePulse2=function(){0===this.p2TimerValue?(this.p2TimerValue=2*this.p2Timer+1,this.p2DutyIndex++,this.p2DutyIndex&=7):this.p2TimerValue--;let a=this.dutyCycles[this.p2Duty][this.p2DutyIndex];this.p2Output=0===a||this.p2SweepMuting||0===this.p2Counter?0:this.p2ConstantVolume?this.p2Volume:this.p2Decay},this.cycleTriangle=function(){0===this.triTimerValue?(this.triTimerValue=this.triTimer,0!==this.triCounter&&0!==this.triLinearCounter&&(this.triOutput=this.triangleSteps[this.triStepIndex++],2>this.triTimer&&(this.triOutput=7.5),this.triStepIndex&=31)):this.triTimerValue--},this.cycleNoise=function(){if(0!==this.noiseTimerValue)this.noiseTimerValue--;else{this.noiseTimerValue=this.noiseTimer;let a=1&this.noiseShift;a^=this.noiseTonal?(64&this.noiseShift)>>6:(2&this.noiseShift)>>1,this.noiseShift>>=1,this.noiseShift|=a<<14}this.noiseOutput=0===this.noiseCounter||1==(1&this.noiseShift)?0:this.noiseConstantVolume?this.noiseVolume:this.noiseDecay},this.cycleDmc=function(){0===this.dmcTimerValue?(this.dmcTimerValue=this.dmcTimer,!this.dmcSilent&&(0==(1&this.dmcShifter)?2<=this.dmcOutput&&(this.dmcOutput-=2):125>=this.dmcOutput&&(this.dmcOutput+=2)),this.dmcShifter>>=1,this.dmcBitsLeft--,0===this.dmcBitsLeft&&(this.dmcBitsLeft=8,this.dmcSampleEmpty?this.dmcSilent=!0:(this.dmcSilent=!1,this.dmcShifter=this.dmcSample,this.dmcSampleEmpty=!0))):this.dmcTimerValue--,0<this.dmcBytesLeft&&this.dmcSampleEmpty&&(this.dmcSampleEmpty=!1,this.dmcSample=this.nes.read(this.dmcAddress),this.dmcAddress++,65536===this.dmcAddress&&(this.dmcAddress=32768),this.dmcBytesLeft--,0===this.dmcBytesLeft&&this.dmcLoop?(this.dmcBytesLeft=this.dmcSampleLength,this.dmcAddress=this.dmcSampleAddress):0===this.dmcBytesLeft&&this.dmcInterrupt&&(this.nes.dmcIrqWanted=!0))},this.updateSweepP1=function(){let a=this.p1Timer>>this.p1SweepShift;this.p1SweepNegate&&(a=-a-1),this.p1SweepTarget=this.p1Timer+a,this.p1SweepMuting=!!(2047<this.p1SweepTarget||8>this.p1Timer)},this.updateSweepP2=function(){let a=this.p2Timer>>this.p2SweepShift;this.p2SweepNegate&&(a=-a),this.p2SweepTarget=this.p2Timer+a,this.p2SweepMuting=!!(2047<this.p2SweepTarget||8>this.p2Timer)},this.clockQuarter=function(){this.triReloadLinear?this.triLinearCounter=this.triLinearReload:0!==this.triLinearCounter&&this.triLinearCounter--,this.triCounterHalt||(this.triReloadLinear=!1),this.p1EnvelopeStart?(this.p1EnvelopeStart=!1,this.p1Decay=15,this.p1EnvelopeCounter=this.p1Volume):0===this.p1EnvelopeCounter?(this.p1EnvelopeCounter=this.p1Volume,0===this.p1Decay?this.p1CounterHalt&&(this.p1Decay=15):this.p1Decay--):this.p1EnvelopeCounter--,this.p2EnvelopeStart?(this.p2EnvelopeStart=!1,this.p2Decay=15,this.p2EnvelopeCounter=this.p2Volume):0===this.p2EnvelopeCounter?(this.p2EnvelopeCounter=this.p2Volume,0===this.p2Decay?this.p2CounterHalt&&(this.p2Decay=15):this.p2Decay--):this.p2EnvelopeCounter--,this.noiseEnvelopeStart?(this.noiseEnvelopeStart=!1,this.noiseDecay=15,this.noiseEnvelopeCounter=this.noiseVolume):0===this.noiseEnvelopeCounter?(this.noiseEnvelopeCounter=this.noiseVolume,0===this.noiseDecay?this.noiseCounterHalt&&(this.noiseDecay=15):this.noiseDecay--):this.noiseEnvelopeCounter--},this.clockHalf=function(){this.p1CounterHalt||0===this.p1Counter||this.p1Counter--,this.p2CounterHalt||0===this.p2Counter||this.p2Counter--,this.triCounterHalt||0===this.triCounter||this.triCounter--,this.noiseCounterHalt||0===this.noiseCounter||this.noiseCounter--,0===this.p1SweepTimer&&this.p1SweepEnabled&&!this.p1SweepMuting&&0<this.p1SweepShift&&(this.p1Timer=this.p1SweepTarget,this.updateSweepP1()),0===this.p1SweepTimer||this.p1SweepReload?(this.p1SweepTimer=this.p1SweepPeriod,this.p1SweepReload=!1):this.p1SweepTimer--,0===this.p2SweepTimer&&this.p2SweepEnabled&&!this.p2SweepMuting&&0<this.p2SweepShift&&(this.p2Timer=this.p2SweepTarget,this.updateSweepP2()),0===this.p2SweepTimer||this.p2SweepReload?(this.p2SweepTimer=this.p2SweepPeriod,this.p2SweepReload=!1):this.p2SweepTimer--},this.mix=function(){let a=.00851*this.triOutput+.00494*this.noiseOutput+.00335*this.dmcOutput,b=.00752*(this.p1Output+this.p2Output);return a+b},this.handleFrameCounter=function(){7457===this.frameCounter?this.clockQuarter():14913===this.frameCounter?(this.clockQuarter(),this.clockHalf()):22371===this.frameCounter?this.clockQuarter():29829!==this.frameCounter||this.step5Mode?37281===this.frameCounter&&(this.clockQuarter(),this.clockHalf()):(this.clockQuarter(),this.clockHalf(),!this.interruptInhibit&&(this.nes.frameIrqWanted=!0))},this.getOutput=function(){let a=[this.outputOffset,this.output];return this.outputOffset=0,a},this.peak=function(a){if(16405===a){let a=0;return a|=0<this.p1Counter?1:0,a|=0<this.p2Counter?2:0,a|=0<this.triCounter?4:0,a|=0<this.noiseCounter?8:0,a|=0<this.dmcBytesLeft?16:0,a|=this.nes.frameIrqWanted?64:0,a|=this.nes.dmcIrqWanted?128:0,a}return 0},this.read=function(a){if(16405===a){let a=0;return a|=0<this.p1Counter?1:0,a|=0<this.p2Counter?2:0,a|=0<this.triCounter?4:0,a|=0<this.noiseCounter?8:0,a|=0<this.dmcBytesLeft?16:0,a|=this.nes.frameIrqWanted?64:0,a|=this.nes.dmcIrqWanted?128:0,this.nes.frameIrqWanted=!1,a}return 0},this.write=function(a,b){switch(a){case 16384:{this.p1Duty=(192&b)>>6,this.p1Volume=15&b,this.p1CounterHalt=0<(32&b),this.p1ConstantVolume=0<(16&b);break}case 16385:{this.p1SweepEnabled=0<(128&b),this.p1SweepPeriod=(112&b)>>4,this.p1SweepNegate=0<(8&b),this.p1SweepShift=7&b,this.p1SweepReload=!0,this.updateSweepP1();break}case 16386:{this.p1Timer&=1792,this.p1Timer|=b,this.updateSweepP1();break}case 16387:{this.p1Timer&=255,this.p1Timer|=(7&b)<<8,this.p1DutyIndex=0,this.enablePulse1&&(this.p1Counter=this.lengthLoadValues[(248&b)>>3]),this.p1EnvelopeStart=!0,this.updateSweepP1();break}case 16388:{this.p2Duty=(192&b)>>6,this.p2Volume=15&b,this.p2CounterHalt=0<(32&b),this.p2ConstantVolume=0<(16&b);break}case 16389:{this.p2SweepEnabled=0<(128&b),this.p2SweepPeriod=(112&b)>>4,this.p2SweepNegate=0<(8&b),this.p2SweepShift=7&b,this.p2SweepReload=!0,this.updateSweepP2();break}case 16390:{this.p2Timer&=1792,this.p2Timer|=b,this.updateSweepP2();break}case 16391:{this.p2Timer&=255,this.p2Timer|=(7&b)<<8,this.p2DutyIndex=0,this.enablePulse2&&(this.p2Counter=this.lengthLoadValues[(248&b)>>3]),this.p2EnvelopeStart=!0,this.updateSweepP2();break}case 16392:{this.triCounterHalt=0<(128&b),this.triLinearReload=127&b;break}case 16394:{this.triTimer&=1792,this.triTimer|=b;break}case 16395:{this.triTimer&=255,this.triTimer|=(7&b)<<8,this.enableTriangle&&(this.triCounter=this.lengthLoadValues[(248&b)>>3]),this.triReloadLinear=!0;break}case 16396:{this.noiseCounterHalt=0<(32&b),this.noiseConstantVolume=0<(16&b),this.noiseVolume=15&b;break}case 16398:{this.noiseTonal=0<(128&b),this.noiseTimer=this.noiseLoadValues[15&b]-1;break}case 16399:{this.enableNoise&&(this.noiseCounter=this.lengthLoadValues[(248&b)>>3]),this.noiseEnvelopeStart=!0;break}case 16400:{this.dmcInterrupt=0<(128&b),this.dmcLoop=0<(64&b),this.dmcTimer=this.dmcLoadValues[15&b]-1,this.dmcInterrupt||(this.nes.dmcIrqWanted=!1);break}case 16401:{this.dmcOutput=127&b;break}case 16402:{this.dmcSampleAddress=49152|b<<6;break}case 16403:{this.dmcSampleLength=(b<<4)+1;break}case 16405:{this.enableNoise=0<(8&b),this.enableTriangle=0<(4&b),this.enablePulse2=0<(2&b),this.enablePulse1=0<(1&b),this.enablePulse1||(this.p1Counter=0),this.enablePulse2||(this.p2Counter=0),this.enableTriangle||(this.triCounter=0),this.enableNoise||(this.noiseCounter=0),0<(16&b)?0===this.dmcBytesLeft&&(this.dmcBytesLeft=this.dmcSampleLength,this.dmcAddress=this.dmcSampleAddress):this.dmcBytesLeft=0,this.nes.dmcIrqWanted=!1;break}case 16407:{this.step5Mode=0<(128&b),this.interruptInhibit=0<(64&b),this.interruptInhibit&&(this.nes.frameIrqWanted=!1),this.frameCounter=0,this.step5Mode&&(this.clockQuarter(),this.clockHalf());break}default:}}}